<div class="row text-center mb-4">
    <div class="col-md-4"><div class="card h-100"><div class="card-body"><h5 class="card-title">Tickets por Estado</h5><canvas id="graficaEstadoTickets"></canvas></div></div></div>
    <div class="col-md-4"><div class="card h-100"><div class="card-body"><h5 class="card-title">Top 5 Herramientas con Más Fallas</h5><div class="list-group list-group-flush">{% for item in top_herramientas_fallas %}<a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" hx-get="{% url 'modal_detalles_modelo' %}?modelo={{ item.herramienta__modelo }}" hx-target="#modal-container" data-bs-toggle="modal" data-bs-target="#modal-container">{{ item.herramienta__modelo|default:"N/A" }}<span class="badge bg-danger rounded-pill">{{ item.total }}</span></a>{% empty %}<li class="list-group-item">No hay datos.</li>{% endfor %}</div></div></div></div>
    <div class="col-md-4"><div class="card h-100"><div class="card-body d-flex flex-column justify-content-center"><h5 class="card-title">Eficiencia de Cierre</h5><h1 class="display-4 fw-bold">{{ porcentaje_eficiencia }}%</h1><p class="card-text text-muted">de {{ total_tickets }} tickets en el periodo</p></div></div></div>
</div>

<div class="row mt-4">
    <div class="col-12"><div class="card"><div class="card-header"><h5 class="card-title mb-0">⚠️ Top 5 Tickets Abiertos Más Antiguos</h5></div><div class="list-group list-group-flush">{% for ticket in top_tickets_antiguos %}<a href="{% url 'detalles_ticket' ticket.pk %}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"><div><strong>{{ ticket.folio }}</strong> - {{ ticket.herramienta }}<small class="d-block text-muted">Creado por {{ ticket.creado_por.username }} en estado '{{ ticket.estado.nombre }}'</small></div><span class="badge bg-danger rounded-pill">Abierto hace {{ ticket.fecha_creacion|timesince }}</span></a>{% empty %}<div class="list-group-item">No hay tickets antiguos abiertos.</div>{% endfor %}</div></div></div>
</div>

<hr>
<h4 class="mt-4">Resultados Filtrados</h4>
<div class="table-responsive">
    {% include 'partials/tabla_tickets.html' %}
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Aseguramos que el código de la gráfica solo se ejecute si el canvas existe
        const canvas = document.getElementById('graficaEstadoTickets');
        if (canvas) {
            let chartStatus = Chart.getChart(canvas);
            if (chartStatus != undefined) {
                chartStatus.destroy();
            }
            const ctx = canvas.getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: {{ contexto_graficas.estado_labels|json_script:"estado-labels" }},
                    datasets: [{
                        label: 'Tickets',
                        data: {{ contexto_graficas.estado_data|json_script:"estado-data" }},
                        backgroundColor: {{ contexto_graficas.estado_colors|json_script:"estado-colors" }},
                        borderWidth: 1
                    }]
                },
                options: { responsive: true, plugins: { legend: { position: 'top' } } }
            });
        }
    });
</script>