{% extends 'base.html' %}

{% block content %}
<div class="card mb-4">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h1 class="mb-0">Dashboard de Service Line</h1>
            <a href="{% url 'exportar_tickets' %}?start_date={{ start_date_value }}&end_date={{ end_date_value }}&estado={{ request.GET.estado|default:'' }}&turno={{ request.GET.turno|default:'' }}&fabricante={{ request.GET.fabricante|default:'' }}" class="btn btn-success">
                <i class="bi bi-file-earmark-excel me-2"></i>Exportar a Excel
            </a>
        </div>
    </div>
    <div class="card-body">
        <form method="get" class="row g-3 mb-4 p-3 border rounded align-items-end">
            <div class="col-md-3"><label class="form-label fw-bold">Fecha de Inicio</label><input type="date" name="start_date" class="form-control" value="{{ start_date_value }}"></div>
            <div class="col-md-3"><label class="form-label fw-bold">Fecha de Fin</label><input type="date" name="end_date" class="form-control" value="{{ end_date_value }}"></div>
            <div class="col-md-2"><label class="form-label fw-bold">Estado</label><select name="estado" class="form-select"><option value="">Todos</option>{% for e in opciones_estado %}<option value="{{ e.pk }}" {% if request.GET.estado == e.pk|stringformat:"s" %}selected{% endif %}>{{ e.nombre }}</option>{% endfor %}</select></div>
            <div class="col-md-2"><label class="form-label fw-bold">Turno</label><select name="turno" class="form-select"><option value="">Todos</option>{% for t in opciones_turno %}<option value="{{ t }}" {% if request.GET.turno == t %}selected{% endif %}>{{ t }}</option>{% endfor %}</select></div>
            <div class="col-md-2"><label class="form-label fw-bold">Fabricante</label><select name="fabricante" class="form-select"><option value="">Todos</option>{% for f in opciones_fabricante %}<option value="{{ f }}" {% if request.GET.fabricante == f %}selected{% endif %}>{{ f }}</option>{% endfor %}</select></div>
            <div class="col-12"><button type="submit" class="btn btn-primary w-100 mt-2">Aplicar Filtros</button></div>
        </form>

        <div class="row text-center mb-4">
            <div class="col-md-4"><div class="card h-100"><div class="card-body"><h5 class="card-title">Tickets por Estado</h5><div class="position-relative"><canvas id="graficaEstadoTickets"></canvas><div class="position-absolute top-50 start-50 translate-middle text-center"><div style="font-size: 1.8rem; font-weight: bold;">{{ eficiencia_ponderada }}%</div><div class="text-muted" style="font-size: 0.8rem;">Eficiencia</div></div></div></div></div></div>
            <div class="col-md-4"><div class="card h-100"><div class="card-body"><h5 class="card-title">Tickets por Turno</h5><canvas id="graficaTurnoTickets"></canvas></div></div></div>
            <div class="col-md-4"><div class="card h-100"><div class="card-body"><h5 class="card-title">Top 5 Herramientas con Más Fallas</h5><div class="list-group list-group-flush">{% for item in top_herramientas_fallas %}<a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" hx-get="{% url 'modal_detalles_filtrados' %}?filtro_tipo=modelo&filtro_valor={{ item.herramienta__modelo|urlencode }}" hx-target="#modal-container">{{ item.herramienta__modelo|default:"N/A" }}<span class="badge bg-danger rounded-pill">{{ item.total }}</span></a>{% empty %}<li class="list-group-item">No hay datos.</li>{% endfor %}</div></div></div></div>
        </div>

        <div class="row mt-4">
            <div class="col-12"><div class="card"><div class="card-header"><h5 class="card-title mb-0">⚠️ Top 5 Tickets Abiertos Más Antiguos</h5></div><div class="list-group list-group-flush">{% for ticket in top_tickets_antiguos %}<a href="{% url 'detalles_ticket' ticket.pk %}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"><div><strong>{{ ticket.folio }}</strong> - {{ ticket.herramienta }}<small class="d-block text-muted">Creado por {{ ticket.creado_por.username }} en estado '{{ ticket.estado.nombre }}'</small></div><span class="badge bg-danger rounded-pill">Abierto hace {{ ticket.fecha_creacion|timesince }}</span></a>{% empty %}<div class="list-group-item">No hay tickets antiguos abiertos.</div>{% endfor %}</div></div></div>
        </div>

        <hr>
        <h4 class="mt-4">Resultados Filtrados</h4>
        {% include 'partials/tabla_tickets.html' %}
    </div>
</div>

<div id="modal-container" hx-on::after-swap="new bootstrap.Modal(document.getElementById('detallesModal')).show()">
</div>
{% endblock content %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        
        function handleChartClick(event, elements, chart) {
            if (elements.length === 0) return;

            const clickedIndex = elements[0].index;
            const dates = `&start_date={{ start_date_value }}&end_date={{ end_date_value }}`;
            let url = `{% url 'modal_detalles_filtrados' %}?`;
            
            if (chart.canvas.id === 'graficaEstadoTickets') {
                const estado = chart.data.labels[clickedIndex];
                url += `filtro_tipo=estado&filtro_valor=${encodeURIComponent(estado)}${dates}`;
            } else if (chart.canvas.id === 'graficaTurnoTickets') {
                const turno = chart.data.labels[clickedIndex];
                const datasetIndex = elements[0].datasetIndex;
                const estado = chart.data.datasets[datasetIndex].label;
                url += `filtro_tipo=turno_estado&filtro_valor=${encodeURIComponent(turno)}&filtro_valor2=${encodeURIComponent(estado)}${dates}`;
            }

            if (url) {
                htmx.ajax('GET', url, {target: '#modal-container'});
            }
        }

        const canvasEstado = document.getElementById('graficaEstadoTickets');
        if (canvasEstado) {
            new Chart(canvasEstado.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: {{ contexto_graficas.estado_labels|safe }},
                    datasets: [{ data: {{ contexto_graficas.estado_data|safe }}, backgroundColor: {{ contexto_graficas.estado_colors|safe }}, borderWidth: 1 }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: true, position: 'bottom' },
                        datalabels: {
                            formatter: (value) => value > 0 ? value : '',
                            color: '#fff',
                            font: { weight: 'bold' }
                        }
                    },
                    cutout: '70%',
                    onClick: handleChartClick
                }
            });
        }

        const canvasTurno = document.getElementById('graficaTurnoTickets');
        if (canvasTurno) {
            new Chart(canvasTurno.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: {{ contexto_graficas.stacked_bar_labels|safe }},
                    datasets: {{ contexto_graficas.stacked_bar_datasets|safe }}
                },
                options: {
                    responsive: true,
                    plugins: { 
                        legend: { position: 'top' },
                         datalabels: {
                            color: '#fff', font: { weight: 'bold' },
                            formatter: (value) => value > 0 ? value : ''
                        }
                    },
                    scales: { x: { stacked: true }, y: { stacked: true } },
                    onClick: handleChartClick
                }
            });
        }
    });
</script>
{% endblock extra_js %}